<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Orphan QC Pulls - Seeds Dashboard
    </title>
    <script src="https://cdn.tailwindcss.com">

    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex">
            <div class="flex-shrink-0 flex items-center">
              <a href="{{ route('home') }}" class="flex items-center text-xl font-bold text-gray-900">
                <img src="/favicon.png" alt="Seeds Dashboard" width="32" height="32" class="h-8 w-8 mr-2 object-contain flex-shrink-0" />
                Seeds Dashboard
              </a>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
              <a
                href="{{ route('seeds.index') }}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >Seed templates</a>
              <a
                href="{{ route('proofs.index') }}"
                class="border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >QC Pulls</a>
              <a
                href="{{ route('settings.edit') }}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >Settings</a>
            </div>
          </div>
          <div class="flex items-center">
            <!-- Mobile menu button -->
            <button type="button" onclick="document.getElementById('mobileMenu').classList.toggle('hidden')" class="sm:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
              <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
            <form method="POST" action="{{ route('auth.logout') }}" class="hidden sm:block">
              <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
              <button type="submit" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Logout</button>
            </form>
          </div>
        </div>
      </div>
      <!-- Mobile menu -->
      <div id="mobileMenu" class="hidden sm:hidden border-t border-gray-200">
        <div class="pt-2 pb-3 space-y-1">
          <a href="{{ route('seeds.index') }}" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-50 hover:border-gray-300">Seed templates</a>
          <a href="{{ route('proofs.index') }}" class="block pl-3 pr-4 py-2 border-l-4 border-blue-500 text-base font-medium text-blue-700 bg-blue-50">QC Pulls</a>
          <a href="{{ route('settings.edit') }}" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-50 hover:border-gray-300">Settings</a>
        </div>
        <div class="pt-4 pb-3 border-t border-gray-200">
          <form method="POST" action="{{ route('auth.logout') }}">
            <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
            <button type="submit" class="block w-full text-left pl-3 pr-4 py-2 text-base font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-50">Logout</button>
          </form>
        </div>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <div class="px-4 py-8 sm:px-0">
        <div class="mb-6">
          <h1 class="text-3xl font-bold mb-6">
            QC Pulls
          </h1>

          <!-- Tab Navigation -->
          <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
              <a
                href="{{ route('proofs.index') }}"
                class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
              >
                Seed QC Pulls
              </a>
              <a
                href="{{ route('proofs.indexOrphanProofs') }}"
                class="border-blue-500 text-blue-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
              >
                Orphan QC Pulls
              </a>
              <a
                href="{{ route('proofs.indexPartnerProofs') }}"
                class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
              >
                Partner QC Pulls
              </a>
            </nav>
          </div>
        </div>

        <!-- Upload Form -->
        <div class="bg-white shadow rounded-lg p-4 sm:p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4">Upload Orphan QC Pull</h2>
          <form method="POST" action="{{ route('proofs.uploadOrphanProof') }}" enctype="multipart/form-data" class="space-y-4" id="uploadForm">
            <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
            <input type="hidden" name="proof_type" value="orphan" />
            <div class="flex flex-col sm:flex-row sm:items-end gap-4">
              <div class="flex-1 w-full">
                <label for="file" class="block text-sm font-medium text-gray-700 mb-2">
                  QC Pull Image (with IMB barcode)
                </label>
                <input
                  type="file"
                  id="file"
                  name="file"
                  accept="image/jpeg,image/jpg,image/png"
                  required
                  class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
              <div class="w-full sm:w-auto">
                <label for="resource_id" class="block text-sm font-medium text-gray-700 mb-2">
                  Resource ID
                </label>
                <div class="flex flex-col sm:flex-row gap-2">
                  <input
                    type="text"
                    id="resource_id"
                    name="resource_id"
                    required
                    class="flex-1 sm:w-64 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="psc_1234567890"
                  />
                  <button
                    type="button"
                    id="detectResourceIdBtn"
                    class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm font-medium whitespace-nowrap"
                  >
                    Detect Resource ID from image
                  </button>
                </div>
                <!-- Results container for IMB barcode detection -->
                <div id="imbDetectionResults" class="mt-2 hidden"></div>
              </div>
            </div>

            <!-- Accordion for Optional Fields -->
            <div class="mt-4 border-t border-gray-200 pt-4">
              <button
                type="button"
                id="optionalFieldsToggle"
                class="flex items-center justify-between w-full text-left text-sm font-medium text-gray-700 hover:text-gray-900 focus:outline-none"
                onclick="toggleOptionalFields()"
              >
                <span>Optional fields (click to expand)</span>
                <svg
                  id="optionalFieldsIcon"
                  class="w-5 h-5 text-gray-500 transition-transform duration-200"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div
                id="optionalFieldsContent"
                class="hidden mt-4 space-y-4"
              >

                <div>
                  <label for="additional_file" class="block text-sm font-medium text-gray-700 mb-2">
                    Additional QC Pull Image <span class="text-gray-400 font-normal">(optional)</span>
                  </label>
                  <input
                    type="file"
                    id="additional_file"
                    name="additional_file"
                    accept="image/jpeg,image/jpg,image/png"
                    class="block w-full sm:max-w-md text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"
                  />
                  <p class="mt-1 text-xs text-gray-500">
                    Upload other side of the mailpiece (without IMB barcode)
                  </p>
                </div>



                <!-- Additional Optional Fields -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-gray-200">
                  <div>
                    <label for="created_by" class="block text-sm font-medium text-gray-700 mb-2">
                      Created by <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <input type="hidden" id="user-email-base64" value="{{ userEmailBase64 }}" />
                    <input
                      type="text"
                      id="created_by"
                      name="created_by"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    />
                  </div>

                  <div>
                  <label for="batch_id" class="block text-sm font-medium text-gray-700 mb-2">
                    Batch ID <span class="text-gray-400 font-normal">(optional)</span>
                  </label>
                  <input
                    type="text"
                    id="batch_id"
                    name="batch_id"
                    class="w-full sm:max-w-md px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Enter batch ID"
                  />
                </div>

                  <div>
                    <label for="receive_date" class="block text-sm font-medium text-gray-700 mb-2">
                      Receive Date <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <input
                      type="date"
                      id="receive_date"
                      name="receive_date"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    />
                  </div>

                  <div>
                    <label for="delivery_quality" class="block text-sm font-medium text-gray-700 mb-2">
                      Delivery Quality <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <select
                      id="delivery_quality"
                      name="delivery_quality"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="">Select quality...</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                    </select>
                  </div>

                  <div>
                    <label for="delivery_quality_tags_input" class="block text-sm font-medium text-gray-700 mb-2">
                      Delivery Quality Tags <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <div class="border border-gray-300 rounded-md shadow-sm focus-within:ring-blue-500 focus-within:border-blue-500 min-h-[42px] p-2 flex flex-wrap gap-2 relative">
                      <div id="delivery_quality_tags_chips" class="flex flex-wrap gap-2 flex-1"></div>
                      <input
                        type="text"
                        id="delivery_quality_tags_input"
                        placeholder="Type to search or create tag..."
                        class="flex-1 min-w-[200px] px-2 py-1 border-0 focus:outline-none focus:ring-0"
                        autocomplete="off"
                      />
                      <div id="delivery_quality_tags_dropdown" class="hidden absolute left-0 top-full mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto z-50"></div>
                    </div>
                    <input type="hidden" id="delivery_quality_tags" name="delivery_quality_tags" />
                  </div>

                  <div>
                    <label for="delivery_date" class="block text-sm font-medium text-gray-700 mb-2">
                      Delivery Time <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <input
                      type="date"
                      id="delivery_date"
                      name="delivery_date"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    />
                  </div>

                  <div>
                    <label for="mailpiece_count" class="block text-sm font-medium text-gray-700 mb-2">
                      Mailpiece count <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <select
                      id="mailpiece_count"
                      name="mailpiece_count"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="">Select count...</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                    </select>
                  </div>

                  <div>
                    <label for="print_quality" class="block text-sm font-medium text-gray-700 mb-2">
                      Print quality <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <select
                      id="print_quality"
                      name="print_quality"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="">Select quality...</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                    </select>
                  </div>

                  <div>
                    <label for="print_quality_tags_input" class="block text-sm font-medium text-gray-700 mb-2">
                      Print Quality Tags <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <div class="border border-gray-300 rounded-md shadow-sm focus-within:ring-blue-500 focus-within:border-blue-500 min-h-[42px] p-2 flex flex-wrap gap-2 relative">
                      <div id="print_quality_tags_chips" class="flex flex-wrap gap-2 flex-1"></div>
                      <input
                        type="text"
                        id="print_quality_tags_input"
                        placeholder="Type to search or create tag..."
                        class="flex-1 min-w-[200px] px-2 py-1 border-0 focus:outline-none focus:ring-0"
                        autocomplete="off"
                      />
                      <div id="print_quality_tags_dropdown" class="hidden absolute left-0 top-full mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto z-50"></div>
                    </div>
                    <input type="hidden" id="print_quality_tags" name="print_quality_tags" />
                  </div>

                  <div class="sm:col-span-2">
                    <label for="product_size_select" class="block text-sm font-medium text-gray-700 mb-2">
                      Product size <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <select
                      id="product_size_select"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="">Select a size...</option>
                      <option value="4x6">4x6</option>
                      <option value="6x9">6x9</option>
                      <option value="6x11">6x11</option>
                      <option value="9x12">9x12</option>
                      <option value="18x6">18x6</option>
                      <option value="8.5x11">8.5x11</option>
                      <option value="custom">Custom (type below)</option>
                    </select>
                    <input type="hidden" id="product_size" name="product_size" />
                    <div id="product_size_custom_container" class="hidden mt-2">
                      <label for="product_size_custom" class="block text-sm font-medium text-gray-700 mb-2">
                        Custom Product Size <span class="text-gray-400 font-normal">(optional)</span>
                      </label>
                      <input
                        type="text"
                        id="product_size_custom"
                        placeholder="Enter custom size"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                      />
                    </div>
                  </div>

                  <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                      Status <span class="text-gray-400 font-normal">(optional)</span>
                    </label>
                    <select
                      id="status"
                      name="status"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="">Select status...</option>
                      <option value="Not started">Not started</option>
                      <option value="Received">Received</option>
                      <option value="Done">Done</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label for="comments" class="block text-sm font-medium text-gray-700 mb-2">
                    Comments <span class="text-gray-400 font-normal">(optional)</span>
                  </label>
                  <textarea
                    id="comments"
                    name="comments"
                    rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Enter any additional comments..."
                  ></textarea>
                </div>
              </div>
            </div>

            <div class="mt-6 flex justify-end">
              <button
                type="submit"
                class="w-full sm:w-auto px-6 py-2.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium"
              >
                Upload
              </button>
            </div>
          </form>
        </div>

        <!-- Flash Messages -->
        @if(flashMessages.has('success'))
          <div class="mb-4 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded">
            {{ flashMessages.get('success') }}
          </div>
        @endif

        @if(flashMessages.has('errors'))
          <div class="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
            @if(typeof flashMessages.get('errors') === 'object')
              @each((error, key) in flashMessages.get('errors'))
                <p>{{ error }}</p>
              @endeach
            @else
              <p>{{ flashMessages.get('errors') }}</p>
            @endif
          </div>
        @endif

        <!-- Error Message -->
        @if(error)
          <div class="mb-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
            {{ error }}
          </div>
        @endif

        <!-- Proofs List -->
        <div id="proofs-content">
        </div>
        <!-- Debug: groups count from server -->
        <div style="display: none;" id="debug-info">
          Groups count: {{ groups.length }}
        </div>
        <script>
          const groupsBase64 = "{{ groupsBase64 }}";
          const csrfToken = "{{ csrfToken }}";

          // Get user email from hidden input and decode from base64 to avoid Edge template escaping issues
          const emailBase64Input = document.getElementById("user-email-base64");
          const createdByInput = document.getElementById("created_by");
          if (emailBase64Input && createdByInput) {
            const userEmailBase64 = emailBase64Input.value;
            console.log('Raw base64 from hidden input:', userEmailBase64);
            console.log('Base64 length:', userEmailBase64?.length);
            if (userEmailBase64) {
              try {
                const userEmail = atob(userEmailBase64);
                console.log('Decoded user email:', userEmail);
                console.log('Decoded email length:', userEmail.length);
                createdByInput.value = userEmail;
              } catch (e) {
                console.error('Error decoding user email:', e, 'Base64:', userEmailBase64);
              }
            } else {
              console.warn('No base64 value found in hidden input');
            }
          }

          console.log('Orphan - groupsBase64 length:', groupsBase64.length);
          console.log('Orphan - groupsBase64 first 50 chars:', groupsBase64.substring(0, 50));
          console.log('Orphan - groupsBase64 last 50 chars:', groupsBase64.substring(Math.max(0, groupsBase64.length - 50)));
          let groups;
          try {
            groups = JSON.parse(atob(groupsBase64));
            console.log('Orphan - Parsed groups:', groups);
            console.log('Orphan - Groups count:', groups?.length || 0);
            if (groups && groups.length > 0) {
              console.log('Orphan - First group:', groups[0]);
            }
          } catch (e) {
            console.error('Orphan - Error parsing groupsBase64:', e);
            console.error('Orphan - groupsBase64 value:', groupsBase64);
            groups = [];
          }
          const container = document.getElementById("proofs-content");

          if (!container) {
            console.error('Orphan - Container element not found!');
          } else if (!groups || groups.length === 0) {
            console.log('Orphan - No groups found, showing empty message');
            container.innerHTML = '<div class="bg-white shadow rounded-lg p-8 text-center"><p class="text-gray-500">No orphan QC pulls yet.</p></div>';
          } else {
            console.log('Orphan - Rendering', groups.length, 'groups');

            // Sort state
            let sortState = {
              column: null,
              direction: 'asc' // 'asc' or 'desc'
            };

            // Helper function to get field value from group
            const getFieldValue = (group, field) => {
              const latestScan = group.latest_scan || {};
              return latestScan[field] || null;
            };

            // Helper function to format field value for display
            const formatFieldValue = (value, field) => {
              if (value === null || value === undefined || value === '') {
                return '-';
              }
              if (field === 'receive_date' || field === 'delivery_time' || field === 'delivery_date' || field === 'created_at' || field === 'updated_at' || field === 'timestamp') {
                if (typeof value === 'string') {
                  try {
                    const date = new Date(value);
                    return date.toLocaleDateString();
                  } catch (e) {
                    return value;
                  }
                }
                return value;
              }
              if ((field === 'print_quality_tags' || field === 'delivery_quality_tags') && Array.isArray(value)) {
                return value.join(', ');
              }
              // Handle JSON array strings
              if ((field === 'print_quality_tags' || field === 'delivery_quality_tags') && typeof value === 'string') {
                try {
                  const parsed = JSON.parse(value);
                  if (Array.isArray(parsed)) {
                    return parsed.join(', ');
                  }
                } catch (e) {
                  // Not JSON, return as-is
                }
              }
              return String(value);
            };

            // Sort function
            const sortGroups = (groupsToSort, column, direction) => {
              const sorted = [...groupsToSort];
              sorted.sort((a, b) => {
                let aVal, bVal;

                // Handle special cases
                if (column === 'resource_id') {
                  aVal = a.resource_id || '';
                  bVal = b.resource_id || '';
                } else if (column === 'total_scans') {
                  aVal = a.total_scans || 0;
                  bVal = b.total_scans || 0;
                } else if (column === 'created_at' || column === 'updated_at') {
                  aVal = getFieldValue(a, column) || getFieldValue(a, 'timestamp') || '';
                  bVal = getFieldValue(b, column) || getFieldValue(b, 'timestamp') || '';
                  // Convert to timestamps for comparison
                  aVal = aVal ? new Date(aVal).getTime() : 0;
                  bVal = bVal ? new Date(bVal).getTime() : 0;
                } else if (column === 'receive_date' || column === 'delivery_time' || column === 'delivery_date') {
                  // Handle date fields
                  if (column === 'delivery_time') {
                    aVal = getFieldValue(a, 'delivery_time') || getFieldValue(a, 'delivery_date') || '';
                    bVal = getFieldValue(b, 'delivery_time') || getFieldValue(b, 'delivery_date') || '';
                  } else {
                    aVal = getFieldValue(a, column) || '';
                    bVal = getFieldValue(b, column) || '';
                  }
                  // Convert to timestamps for comparison
                  aVal = aVal ? new Date(aVal).getTime() : 0;
                  bVal = bVal ? new Date(bVal).getTime() : 0;
                } else {
                  // Handle created_by which might be uploaded_by
                  if (column === 'created_by') {
                    aVal = getFieldValue(a, 'created_by') || getFieldValue(a, 'uploaded_by');
                    bVal = getFieldValue(b, 'created_by') || getFieldValue(b, 'uploaded_by');
                  } else if (column === 'delivery_quality_comments') {
                    // Handle delivery_quality_comments which might be comments
                    aVal = getFieldValue(a, 'delivery_quality_comments') || getFieldValue(a, 'comments');
                    bVal = getFieldValue(b, 'delivery_quality_comments') || getFieldValue(b, 'comments');
                  } else {
                    aVal = getFieldValue(a, column);
                    bVal = getFieldValue(b, column);
                  }

                  // Handle null/undefined
                  if (aVal === null || aVal === undefined || aVal === '') {
                    aVal = '';
                  }
                  if (bVal === null || bVal === undefined || bVal === '') {
                    bVal = '';
                  }

                  // Try to convert to number if possible
                  const aNum = Number(aVal);
                  const bNum = Number(bVal);
                  if (!isNaN(aNum) && !isNaN(bNum) && String(aNum) === String(aVal) && String(bNum) === String(bVal)) {
                    aVal = aNum;
                    bVal = bNum;
                  } else {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                  }
                }

                if (aVal < bVal) {
                  return direction === 'asc' ? -1 : 1;
                }
                if (aVal > bVal) {
                  return direction === 'asc' ? 1 : -1;
                }
                return 0;
              });
              return sorted;
            };

            // Function to render sortable header
            const renderSortableHeader = (label, column) => {
              const isActive = sortState.column === column;
              const sortIcon = isActive
                ? sortState.direction === 'asc'
                  ? '<svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" /></svg>'
                  : '<svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>'
                : '<svg class="w-4 h-4 inline ml-1 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>';

              return `
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none ${isActive ? 'bg-gray-100' : ''}"
                  onclick="event.stopPropagation(); handleSort('${column}')"
                >
                  <div class="flex items-center">
                    <span>${label}</span>
                    ${sortIcon}
                  </div>
                </th>
              `;
            };

            // Function to handle sorting
            window.handleSort = function(column) {
              if (sortState.column === column) {
                // Toggle direction if same column
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
              } else {
                // New column, default to ascending
                sortState.column = column;
                sortState.direction = 'asc';
              }
              renderTable();
            };

            // Function to render the table
            const renderTable = () => {
              const sortedGroups = sortState.column
                ? sortGroups(groups, sortState.column, sortState.direction)
                : groups;

              const getThumbnailCell = (group) => {
                const latestScan = group.latest_scan || {};
                const thumbnailUrl = latestScan.url || latestScan.s3_uri || null;
                return thumbnailUrl
                  ? `<img src="${thumbnailUrl}" alt="Thumbnail" class="w-16 h-12 object-cover rounded border border-gray-200" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'64\\' height=\\'48\\'%3E%3Crect fill=\\'%23e5e7eb\\' width=\\'64\\' height=\\'48\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%239ca3af\\' font-size=\\'10\\'%3E-%3C/text%3E%3C/svg%3E';" />`
                  : `<span class="text-gray-400 text-xs">-</span>`;
              };

              // Mobile cards
              const cards = sortedGroups.map(group => {
                const latestScan = group.latest_scan || {};
                const showUrl = group.showUrl || `/proofs/orphan/${group.resource_id}`;
                const createdAt = latestScan.created_at || latestScan.timestamp || '-';
                const updatedAt = latestScan.updated_at || latestScan.timestamp || '-';
                const productSize = formatFieldValue(getFieldValue(group, 'product_size'), 'product_size');
                const createdBy = formatFieldValue(getFieldValue(group, 'created_by') || getFieldValue(group, 'uploaded_by'), 'created_by');
                const status = formatFieldValue(getFieldValue(group, 'status'), 'status');
                const printQuality = formatFieldValue(getFieldValue(group, 'print_quality'), 'print_quality');
                const deliveryQuality = formatFieldValue(getFieldValue(group, 'delivery_quality'), 'delivery_quality');

                return `
                  <div class="bg-white shadow rounded-lg p-4 cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition-colors" onclick="window.location.href='${showUrl}'">
                    <div class="flex items-start gap-4">
                      <div class="flex-shrink-0">${getThumbnailCell(group)}</div>
                      <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 font-mono truncate mb-1">${group.resource_id || "-"}</div>
                        ${createdBy !== '-' ? `<div class="text-xs text-gray-500">Created By: ${createdBy}</div>` : ''}
                        ${printQuality !== '-' ? `<div class="text-xs text-gray-500">Print Quality: ${printQuality}</div>` : ''}
                        ${deliveryQuality !== '-' ? `<div class="text-xs text-gray-500">Delivery Quality: ${deliveryQuality}</div>` : ''}
                        <div class="text-xs text-gray-500">Total Scans: ${group.total_scans || 0}</div>
                        ${productSize !== '-' ? `<div class="text-xs text-gray-500">Product Size: ${productSize}</div>` : ''}
                        ${status !== '-' ? `<div class="text-xs text-gray-500">Status: ${status}</div>` : ''}
                        <div class="text-xs text-gray-500">Created: ${createdAt}</div>
                        <div class="text-xs text-gray-500">Updated: ${updatedAt}</div>
                      </div>
                    </div>
                    <div class="flex justify-end mt-3 pt-3 border-t border-gray-100">
                      <a href="${showUrl}" class="text-blue-600 hover:text-blue-800 text-sm" onclick="event.stopPropagation()">View</a>
                    </div>
                  </div>
                `;
              }).join("");

              // Desktop table rows
              const rows = sortedGroups.map(group => {
                const latestScan = group.latest_scan || {};
                const showUrl = group.showUrl || `/proofs/orphan/${group.resource_id}`;
                const createdAt = latestScan.created_at || latestScan.timestamp || '-';
                const updatedAt = latestScan.updated_at || latestScan.timestamp || '-';

                // Format dates for display
                const formatDate = (dateStr) => {
                  if (!dateStr || dateStr === '-') return '-';
                  try {
                    return new Date(dateStr).toLocaleDateString();
                  } catch (e) {
                    return dateStr;
                  }
                };

                return `
                  <tr class="cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition-colors" onclick="window.location.href='${showUrl}'">
                    <td class="px-6 py-4 whitespace-nowrap">${getThumbnailCell(group)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm font-medium text-gray-900 font-mono">${group.resource_id || "-"}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatFieldValue(getFieldValue(group, 'created_by') || getFieldValue(group, 'uploaded_by'), 'created_by')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(getFieldValue(group, 'receive_date'))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatFieldValue(getFieldValue(group, 'product_size'), 'product_size')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatFieldValue(getFieldValue(group, 'status'), 'status')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatFieldValue(getFieldValue(group, 'print_quality'), 'print_quality')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatFieldValue(getFieldValue(group, 'delivery_quality'), 'delivery_quality')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(getFieldValue(group, 'delivery_time') || getFieldValue(group, 'delivery_date'))}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatFieldValue(getFieldValue(group, 'mailpiece_count'), 'mailpiece_count')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${group.total_scans || 0}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatFieldValue(getFieldValue(group, 'print_quality_tags'), 'print_quality_tags')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${formatFieldValue(getFieldValue(group, 'delivery_quality_comments') || getFieldValue(group, 'comments'), 'comments')}">${formatFieldValue(getFieldValue(group, 'delivery_quality_comments') || getFieldValue(group, 'comments'), 'comments')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <a href="${showUrl}" class="text-blue-600 hover:text-blue-800" onclick="event.stopPropagation()">View</a>
                    </td>
                  </tr>
                `;
              }).join("");

              container.innerHTML = `
                <!-- Mobile cards -->
                <div class="md:hidden space-y-4">${cards}</div>
                <!-- Desktop table -->
                <div class="hidden md:block bg-white shadow rounded-lg overflow-x-auto">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thumbnail</th>
                        ${renderSortableHeader('Resource ID', 'resource_id')}
                        ${renderSortableHeader('Created By', 'created_by')}
                        ${renderSortableHeader('Receive Date', 'receive_date')}
                        ${renderSortableHeader('Product Size', 'product_size')}
                        ${renderSortableHeader('Status', 'status')}
                        ${renderSortableHeader('Print Quality', 'print_quality')}
                        ${renderSortableHeader('Delivery Quality', 'delivery_quality')}
                        ${renderSortableHeader('Delivery Time', 'delivery_time')}
                        ${renderSortableHeader('Mailpiece Count', 'mailpiece_count')}
                        ${renderSortableHeader('Total Scans', 'total_scans')}
                        ${renderSortableHeader('Print Quality Tags', 'print_quality_tags')}
                        ${renderSortableHeader('Delivery Quality Comments', 'delivery_quality_comments')}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">${rows}</tbody>
                  </table>
                </div>
              `;
            };

            // Initial render
            renderTable();
          }

          // Handle Detect Resource ID button
          document.getElementById("detectResourceIdBtn")?.addEventListener("click", async function() {
            const fileInput = document.getElementById("file");
            const resultsContainer = document.getElementById("imbDetectionResults");
            const resourceIdInput = document.getElementById("resource_id");
            const detectButton = document.getElementById("detectResourceIdBtn");

            if (!fileInput?.files || fileInput.files.length === 0) {
              alert("Please select a file first");
              return;
            }

            // Clear previous results and show loading spinner
            if (resultsContainer) {
              resultsContainer.classList.remove("hidden");
              resultsContainer.innerHTML = `
                <div class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                  <div class="flex items-center gap-2">
                    <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm font-medium text-blue-800">Analyzing image for IMB barcode...</span>
                  </div>
                </div>
              `;
            }

            // Disable button during request
            if (detectButton) {
              detectButton.disabled = true;
              detectButton.classList.add("opacity-50", "cursor-not-allowed");
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            formData.append("_csrf", csrfToken);

            try {
              const response = await fetch("{{ route('proofs.detectResourceId') }}", {
                method: "POST",
                body: formData,
              });

              const data = await response.json();

              if (response.ok && data.found && data.resource_id) {
                // Success: Update resource ID input and display results
                if (resourceIdInput) {
                  resourceIdInput.value = data.resource_id;
                }

                // Display success results
                if (resultsContainer) {
                  let resultsHtml = '<div class="p-3 bg-green-50 border border-green-200 rounded-md">';
                  resultsHtml += '<div class="text-sm font-medium text-green-800 mb-2">Resource ID detected successfully</div>';

                  if (data.tracking_number) {
                    resultsHtml += `<div class="text-sm text-gray-700 mb-1"><span class="font-medium">Tracking Number:</span> ${data.tracking_number}</div>`;
                  }
                  if (data.notes) {
                    resultsHtml += `<div class="text-sm text-gray-700 mb-1"><span class="font-medium">Notes:</span> ${data.notes}</div>`;
                  }
                  if (data.raw_string) {
                    resultsHtml += `<div class="text-sm text-gray-700 mb-1"><span class="font-medium">Raw String:</span> <code class="bg-gray-100 px-1 rounded">${data.raw_string}</code></div>`;
                  }

                  resultsHtml += '</div>';
                  resultsContainer.innerHTML = resultsHtml;
                  resultsContainer.classList.remove("hidden");
                }
              } else if (data.found === false) {
                // Not found: Display yellow warning message
                if (resultsContainer) {
                  const errorMessage = data.error || "Resource ID could not be found from the IMB barcode";
                  resultsContainer.innerHTML = `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                      <div class="text-sm font-medium text-yellow-800">${errorMessage}</div>
                    </div>
                  `;
                  resultsContainer.classList.remove("hidden");
                }
              } else {
                // Error: Display red error message
                if (resultsContainer) {
                  const errorMessage = data.error || "Failed to detect resource ID";
                  resultsContainer.innerHTML = `
                    <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                      <div class="text-sm font-medium text-red-800">${errorMessage}</div>
                    </div>
                  `;
                  resultsContainer.classList.remove("hidden");
                }
              }
            } catch (err) {
              console.error("Error detecting resource ID:", err);
              if (resultsContainer) {
                resultsContainer.innerHTML = `
                  <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                    <div class="text-sm font-medium text-red-800">Failed to detect resource ID. Please enter it manually.</div>
                  </div>
                `;
                resultsContainer.classList.remove("hidden");
              }
            } finally {
              // Re-enable button after request completes
              if (detectButton) {
                detectButton.disabled = false;
                detectButton.classList.remove("opacity-50", "cursor-not-allowed");
              }
            }
          });

          // Toggle optional fields accordion
          function toggleOptionalFields() {
            const content = document.getElementById("optionalFieldsContent");
            const icon = document.getElementById("optionalFieldsIcon");
            if (content && icon) {
              content.classList.toggle("hidden");
              icon.classList.toggle("rotate-180");
            }
          }

          // Handle product size custom field
          document.getElementById("product_size_select")?.addEventListener("change", function() {
            const customContainer = document.getElementById("product_size_custom_container");
            const hiddenInput = document.getElementById("product_size");
            if (this.value === "custom") {
              customContainer?.classList.remove("hidden");
              if (hiddenInput) hiddenInput.value = "";
            } else {
              customContainer?.classList.add("hidden");
              const customInput = document.getElementById("product_size_custom");
              if (customInput) customInput.value = "";
              if (hiddenInput) hiddenInput.value = this.value;
            }
          });

          // Update hidden product_size field when custom input changes
          document.getElementById("product_size_custom")?.addEventListener("input", function() {
            const hiddenInput = document.getElementById("product_size");
            if (hiddenInput) hiddenInput.value = this.value.trim();
          });

          // Tag management for Print Quality Tags and Delivery Quality Tags
          const tagManagers = {
            print: {
              chipsContainer: document.getElementById("print_quality_tags_chips"),
              input: document.getElementById("print_quality_tags_input"),
              dropdown: document.getElementById("print_quality_tags_dropdown"),
              hiddenInput: document.getElementById("print_quality_tags"),
              selectedTags: [],
              allTags: []
            },
            delivery: {
              chipsContainer: document.getElementById("delivery_quality_tags_chips"),
              input: document.getElementById("delivery_quality_tags_input"),
              dropdown: document.getElementById("delivery_quality_tags_dropdown"),
              hiddenInput: document.getElementById("delivery_quality_tags"),
              selectedTags: [],
              allTags: []
            }
          };

          // Create a reusable tag manager function
          function createTagManager(type) {
            const manager = tagManagers[type];
            let dropdownTimeout = null;
            let highlightedIndex = -1;

            function updateHiddenInput() {
              if (manager.hiddenInput) {
                manager.hiddenInput.value = JSON.stringify(manager.selectedTags);
              }
            }

            function renderChips() {
              if (!manager.chipsContainer) return;
              manager.chipsContainer.innerHTML = "";
              manager.selectedTags.forEach((tag, index) => {
                const chip = document.createElement("span");
                chip.className = "inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm";
                chip.innerHTML = `
                  <span>${escapeHtml(tag)}</span>
                  <button type="button" class="hover:text-blue-900 focus:outline-none" data-tag-index="${index}">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                `;
                chip.querySelector("button").addEventListener("click", () => {
                  manager.selectedTags.splice(index, 1);
                  renderChips();
                  updateHiddenInput();
                });
                manager.chipsContainer.appendChild(chip);
              });
            }

            function escapeHtml(text) {
              const div = document.createElement("div");
              div.textContent = text;
              return div.innerHTML;
            }

            function filterTags(query) {
              if (!query) return manager.allTags;
              const lowerQuery = query.toLowerCase();
              return manager.allTags.filter(tag =>
                tag.toLowerCase().includes(lowerQuery) &&
                !manager.selectedTags.includes(tag)
              );
            }

            function renderDropdown(filteredTags) {
              if (!manager.dropdown) return;

              const hasInput = manager.input.value.trim();
              const totalOptions = filteredTags.length + (hasInput ? 1 : 0);

              if (totalOptions === 0) {
                manager.dropdown.classList.add("hidden");
                return;
              }

              const items = filteredTags.map((tag, index) => {
                const isHighlighted = index === highlightedIndex;
                return `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer ${isHighlighted ? 'bg-gray-100' : ''}" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</div>`;
              });

              // Add create option if there's input
              if (hasInput) {
                const createIndex = filteredTags.length;
                const isHighlighted = highlightedIndex === createIndex;
                items.push(`<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer ${isHighlighted ? 'bg-gray-100' : ''}" data-action="create"><span class="text-gray-600">Create "${escapeHtml(manager.input.value.trim())}"</span></div>`);
              }

              manager.dropdown.innerHTML = items.join("");
              manager.dropdown.classList.remove("hidden");
            }

            function hideDropdown() {
              if (manager.dropdown) {
                manager.dropdown.classList.add("hidden");
              }
              highlightedIndex = -1;
            }

            function addTag(tag) {
              const trimmedTag = tag.trim();
              if (trimmedTag && !manager.selectedTags.includes(trimmedTag)) {
                manager.selectedTags.push(trimmedTag);
                renderChips();
                updateHiddenInput();
              }
            }

            function handleInput() {
              const query = manager.input.value;

              if (dropdownTimeout) {
                clearTimeout(dropdownTimeout);
              }

              dropdownTimeout = setTimeout(() => {
                const filtered = filterTags(query);
                renderDropdown(filtered);
              }, 100);
            }

            function handleKeyDown(e) {
              if (e.key === "Enter") {
                e.preventDefault();
                const query = manager.input.value.trim();
                if (query) {
                  addTag(query);
                  manager.input.value = "";
                  hideDropdown();
              } else if (highlightedIndex >= 0 && manager.dropdown) {
                const items = manager.dropdown.querySelectorAll("[data-tag], [data-action]");
                if (items[highlightedIndex]) {
                  const item = items[highlightedIndex];
                  const tag = item.getAttribute("data-tag");
                  const action = item.getAttribute("data-action");
                  if (action === "create") {
                    const tag = manager.input.value.trim();
                    if (tag) {
                      addTag(tag);
                      manager.input.value = "";
                      hideDropdown();
                    }
                  } else if (tag) {
                    addTag(tag);
                    manager.input.value = "";
                    hideDropdown();
                  }
                }
              }
              } else if (e.key === "Escape") {
                hideDropdown();
              } else if (e.key === "ArrowDown") {
                e.preventDefault();
                const filtered = filterTags(manager.input.value);
                const hasCreateOption = manager.input.value.trim();
                const totalOptions = filtered.length + (hasCreateOption ? 1 : 0);
                if (totalOptions > 0) {
                  highlightedIndex = (highlightedIndex + 1) % totalOptions;
                  renderDropdown(filtered);
                }
              } else if (e.key === "ArrowUp") {
                e.preventDefault();
                const filtered = filterTags(manager.input.value);
                const hasCreateOption = manager.input.value.trim();
                const totalOptions = filtered.length + (hasCreateOption ? 1 : 0);
                if (totalOptions > 0) {
                  highlightedIndex = highlightedIndex <= 0 ? totalOptions - 1 : highlightedIndex - 1;
                  renderDropdown(filtered);
                }
              }
            }

            function handleClickOutside(e) {
              if (manager.input && manager.dropdown) {
                if (!manager.input.contains(e.target) && !manager.dropdown.contains(e.target)) {
                  hideDropdown();
                }
              }
            }

            function handleDropdownClick(e) {
              const item = e.target.closest("[data-tag], [data-action]");
              if (item) {
                if (item.getAttribute("data-action") === "create") {
                  const tag = manager.input.value.trim();
                  if (tag) {
                    addTag(tag);
                    manager.input.value = "";
                  }
                } else {
                  const tag = item.getAttribute("data-tag");
                  if (tag) {
                    addTag(tag);
                    manager.input.value = "";
                  }
                }
                hideDropdown();
              }
            }

            // Initialize
            if (manager.input) {
              manager.input.addEventListener("input", handleInput);
              manager.input.addEventListener("keydown", handleKeyDown);
              manager.input.addEventListener("focus", () => {
                const filtered = filterTags(manager.input.value);
                renderDropdown(filtered);
              });
            }

            if (manager.dropdown) {
              manager.dropdown.addEventListener("click", handleDropdownClick);
            }

            document.addEventListener("click", handleClickOutside);

            // Fetch tags from API
            const apiEndpoint = type === "print" ? "/api/print-quality-tags" : "/api/delivery-quality-tags";
            fetch(apiEndpoint)
              .then(response => response.json())
              .then(tags => {
                manager.allTags = tags || [];
              })
              .catch(error => {
                console.error(`Error fetching ${type} quality tags:`, error);
                manager.allTags = [];
              });

            return {
              addTag,
              renderChips,
              updateHiddenInput
            };
          }

          // Initialize both tag managers
          createTagManager("print");
          createTagManager("delivery");
        </script>
      </div>
    </main>
  </body>
</html>
