<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      QC Pull Details - Seeds Dashboard
    </title>
    <script src="https://cdn.tailwindcss.com">

    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex">
            <div class="flex-shrink-0 flex items-center">
              <a href="{{ route('home') }}" class="flex items-center text-xl font-bold text-gray-900">
                <img src="/favicon.png" alt="Seeds Dashboard" width="32" height="32" class="h-8 w-8 mr-2 object-contain flex-shrink-0" />
                Seeds Dashboard
              </a>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
              <a
                href="{{ route('seeds.index') }}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >Seed templates</a>
              <a
                href="{{ route('proofs.index') }}"
                class="border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >QC Pulls</a>
              <a
                href="{{ route('settings.edit') }}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >Settings</a>
            </div>
          </div>
          <div class="flex items-center">
            <form method="POST" action="{{ route('auth.logout') }}">
              <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
              <button type="submit" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Logout</button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <div class="px-4 py-8 sm:px-0">
        <div class="mb-6">
          <a href="{{ route('proofs.index') }}" class="text-blue-600 hover:text-blue-800 mb-4 inline-block">← Back to QC Pulls</a>
          <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold">
              QC Pull Details
            </h1>
            <form
              method="POST"
              action="{{ route('proofs.destroy', { publicId: proof.publicId }) }}"
              onsubmit="return confirm('Are you sure you want to delete this QC pull? This action cannot be undone.');"
            >
              <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
              <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md">
                Delete QC Pull
              </button>
            </form>
          </div>
        </div>

        <script>
          // Declare proof data once at the top for reuse across all script blocks
          const proofBase64 = "{{ proofBase64 }}";

          const proof = JSON.parse(atob(proofBase64));
        </script>

        <!-- Proof Information - Full Width Top Row -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4">
            QC Pull Information
          </h2>

          <dl class="grid grid-cols-2 lg:grid-cols-6 gap-x-10 lg:gap-x-6 gap-y-2">
            <div>
              <dt class="text-xs font-medium text-gray-500">
                Seed
              </dt>
              <dd class="mt-0.5 text-sm text-gray-900">
                @if(proof.seedShowUrl)
                  <a href="{{ proof.seedShowUrl }}" class="text-blue-600 hover:text-blue-800 underline">{{ proof.seedName }}</a>
                @else
                  <span class="{{ proof.isOrphaned ? 'text-gray-500 italic' : '' }}">{{ proof.seedName }}</span>
                  @if(proof.isOrphaned)
                    <span class="text-xs text-gray-400 ml-1">(seed deleted)</span>
                  @endif
                @endif
              </dd>
            </div>
            <div>
              <dt class="text-xs font-medium text-gray-500">
                Status
              </dt>
              <dd class="mt-0.5">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">{{ proof.status }}</span>
              </dd>
            </div>
            <div id="resource-id">
            </div>
            @if(proof.publicId)
              <div>
                <dt class="text-xs font-medium text-gray-500">
                  Public ID
                </dt>
                <dd class="mt-0.5 text-sm text-gray-900 font-mono">
                  {{ proof.publicId }}
                </dd>
              </div>
            @endif
            <div id="size">
            </div>
            <div id="mail-type">
            </div>
            <div id="date-created">
            </div>
            <div id="send-date">
            </div>
            <div id="expected-delivery-date">
            </div>
            <div id="tracking-number">
            </div>
            <div id="delivered-at">
            </div>
          </dl>

          <script>
            if (proof.resourceId) {
              document.getElementById("resource-id").innerHTML = `
                <div>
                  <dt class="text-xs font-medium text-gray-500">Resource ID</dt>
                  <dd class="mt-0.5 text-sm text-gray-900 font-mono">
                    <a href="https://dashboard.lob.com/postcards/${proof.resourceId}" target="_blank" class="text-blue-600 hover:text-blue-800">${proof.resourceId}</a>
                  </dd>
                </div>
              `;
            }

            if (proof.trackingNumber) {
              document.getElementById("tracking-number").innerHTML = `
                <div>
                  <dt class="text-xs font-medium text-gray-500">Tracking Number</dt>
                  <dd class="mt-0.5 text-sm text-gray-900">${proof.trackingNumber}</dd>
                </div>
              `;
            }

            if (proof.deliveredAt) {
              document.getElementById("delivered-at").innerHTML = `
                <div>
                  <dt class="text-xs font-medium text-gray-500">Delivered At</dt>
                  <dd class="mt-0.5 text-sm text-gray-900">${proof.deliveredAt}</dd>
                </div>
              `;
            }

            if (proof.lobDetails) {
              const details = proof.lobDetails;

              if (details.size) {
                document.getElementById("size").innerHTML = `
                  <div>
                    <dt class="text-xs font-medium text-gray-500">Size</dt>
                    <dd class="mt-0.5 text-sm text-gray-900">${details.size}</dd>
                  </div>
                `;
              }

              if (details.mailType) {
                document.getElementById("mail-type").innerHTML = `
                  <div>
                    <dt class="text-xs font-medium text-gray-500">Mail Type</dt>
                    <dd class="mt-0.5 text-sm text-gray-900">${details.mailType}</dd>
                  </div>
                `;
              }

              if (details.dateCreated) {
                document.getElementById("date-created").innerHTML = `
                  <div>
                    <dt class="text-xs font-medium text-gray-500">Date Created</dt>
                    <dd class="mt-0.5 text-sm text-gray-900">${details.dateCreated}</dd>
                  </div>
                `;
              }

              if (details.sendDate) {
                document.getElementById("send-date").innerHTML = `
                  <div>
                    <dt class="text-xs font-medium text-gray-500">Send Date</dt>
                    <dd class="mt-0.5 text-sm text-gray-900">${details.sendDate}</dd>
                  </div>
                `;
              }

              if (details.expectedDeliveryDate) {
                document.getElementById("expected-delivery-date").innerHTML = `
                  <div>
                    <dt class="text-xs font-medium text-gray-500">Expected Delivery Date Range</dt>
                    <dd class="mt-0.5 text-sm text-gray-900">${details.expectedDeliveryDate}</dd>
                  </div>
                `;
              }
            }
          </script>
        </div>

        <!-- Second Row: Lob Rendered Proofs and Live Proofs Side by Side -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">
              Lob Rendered QC Pulls
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
              <div>
                <h3 class="text-sm font-medium text-gray-700 mb-2">
                  Front
                </h3>
                <div id="front-thumbnail">
                </div>
                <script>
                  if (proof.frontThumbnailUrl) {
                    const frontThumbnailUrl = proof.frontThumbnailUrl;
                    document.getElementById("front-thumbnail").innerHTML = `<a href="${frontThumbnailUrl}" target="_blank" rel="noopener noreferrer"><img src="${frontThumbnailUrl}" alt="Postcard front thumbnail" class="w-full rounded-lg shadow-sm hover:opacity-90 cursor-pointer" /></a>`;
                  } else if (proof.thumbnailUrl) {
                    // Fallback to old thumbnailUrl for backward compatibility
                    const thumbnailUrl = proof.thumbnailUrl;
                    document.getElementById("front-thumbnail").innerHTML = `<a href="${thumbnailUrl}" target="_blank" rel="noopener noreferrer"><img src="${thumbnailUrl}" alt="Postcard thumbnail" class="w-full rounded-lg shadow-sm hover:opacity-90 cursor-pointer" /></a>`;
                  }
                </script>
              </div>
              <div class="hidden lg:block">
                <h3 class="text-sm font-medium text-gray-700 mb-2">
                  Back
                </h3>
                <div id="back-thumbnail">
                </div>
                <script>
                  if (proof.backThumbnailUrl) {
                    const backThumbnailUrl = proof.backThumbnailUrl;
                    document.getElementById("back-thumbnail").innerHTML = `<a href="${backThumbnailUrl}" target="_blank" rel="noopener noreferrer"><img src="${backThumbnailUrl}" alt="Postcard back thumbnail" class="w-full rounded-lg shadow-sm hover:opacity-90 cursor-pointer" /></a>`;
                  } else {
                    document.getElementById("back-thumbnail").innerHTML = `<p class="text-sm text-gray-500 italic">No back thumbnail available</p>`;
                  }
                </script>
              </div>
              <!-- Back thumbnail for small screens (toggleable) -->
              <div id="back-thumbnail-mobile" class="lg:hidden hidden">
                <h3 class="text-sm font-medium text-gray-700 mb-2">
                  Back
                </h3>
                <div id="back-thumbnail-mobile-content">
                </div>
              </div>
            </div>
            <!-- Toggle link for small screens -->
            <div id="show-back-link" class="lg:hidden mb-4">
            </div>
            <script>
              // Set up back thumbnail for mobile
              (function() {
                const backThumbnailDiv = document.getElementById("back-thumbnail");
                if (backThumbnailDiv && backThumbnailDiv.innerHTML && !backThumbnailDiv.innerHTML.includes("No back thumbnail")) {
                  // Copy the content from desktop version
                  document.getElementById("back-thumbnail-mobile-content").innerHTML = backThumbnailDiv.innerHTML;
                  document.getElementById("show-back-link").innerHTML = `
                    <button onclick="document.getElementById('back-thumbnail-mobile').classList.toggle('hidden'); this.textContent = document.getElementById('back-thumbnail-mobile').classList.contains('hidden') ? 'Show Back' : 'Hide Back';" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                      Show Back
                    </button>
                  `;
                }
              })();
            </script>
            <div id="lob-urls" class="mt-4 pt-4 border-t border-gray-200">
            </div>
            <script>
              if (proof.lobDetails && (proof.lobDetails.url || proof.lobDetails.rawUrl)) {
                let urlsHtml = '<div class="flex flex-col gap-2">';
                if (proof.lobDetails.url) {
                  urlsHtml += `<a href="${proof.lobDetails.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-sm">View PDF</a>`;
                }
                if (proof.lobDetails.rawUrl) {
                  urlsHtml += `<a href="${proof.lobDetails.rawUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-sm">View Raw PDF</a>`;
                }
                urlsHtml += "</div>";
                document.getElementById("lob-urls").innerHTML = urlsHtml;
              }
            </script>
          </div>

          <div id="live-proof-section" class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">
              Live QC Pulls
            </h2>
            <a
              href="{{ proof.uploadUrl }}"
              class="inline-block bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md text-sm"
            >
              Capture / Upload
            </a>
          </div>
          <div id="scan-events-content">
          </div>
        </div>
        <script>
          (function() {
            const container = document.getElementById("scan-events-content");
            const scanEvents = proof.scanEvents;

            if (!scanEvents || !scanEvents.items || scanEvents.items.length === 0) {
              container.innerHTML = `
                <p class="text-gray-500 italic">No live QC pulls uploaded yet.</p>
              `;
              return;
            }

            const latestScan = scanEvents.items[0];
            const secondScan = scanEvents.items.length > 1 ? scanEvents.items[1] : null;
            const totalCount = scanEvents.count || scanEvents.items.length;

            let html = `
              <div class="space-y-4">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div>
                    <a href="${latestScan.url}" target="_blank" rel="noopener noreferrer">
                      <img
                        src="${latestScan.url}"
                        alt="Latest live QC pull"
                        class="w-full rounded-lg shadow-sm hover:opacity-90 cursor-pointer"
                      />
                    </a>
                    <p class="text-sm text-gray-500 mt-2">
                      Uploaded: ${new Date(latestScan.timestamp || latestScan.created_at).toLocaleString()}
                      ${latestScan.original_filename ? ` • ${latestScan.original_filename}` : ''}
                    </p>
                  </div>
            `;

            if (secondScan) {
              html += `
                  <div class="hidden lg:block">
                    <a href="${secondScan.url}" target="_blank" rel="noopener noreferrer">
                      <img
                        src="${secondScan.url}"
                        alt="Second live QC pull"
                        class="w-full rounded-lg shadow-sm hover:opacity-90 cursor-pointer"
                      />
                    </a>
                    <p class="text-sm text-gray-500 mt-2">
                      Uploaded: ${new Date(secondScan.timestamp || secondScan.created_at).toLocaleString()}
                      ${secondScan.original_filename ? ` • ${secondScan.original_filename}` : ''}
                    </p>
                  </div>
              `;
            }

            html += `</div>`;

            if (totalCount > (secondScan ? 2 : 1)) {
              html += `
                <div class="pt-4 border-t border-gray-200">
                  <a
                    href="/proofs/orphan/${proof.resourceId}"
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                  >
                    View all ${totalCount} uploaded images →
                  </a>
                </div>
              `;
            }

            html += `</div>`;
            container.innerHTML = html;
          })();
        </script>
          </div>
        </div>

        <div class="mt-6 bg-yellow-50 border border-yellow-200 shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-2">
            Dev: Manual Status Update
          </h2>
          <p class="text-sm text-yellow-800 mb-4">
            For development purposes only - manually update QC pull status
          </p>
          <form method="POST" action="{{ proof.updateStatusUrl }}">
            <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
            <div class="flex items-end gap-4">
              <div class="flex-1">
                <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select
                  id="status"
                  name="status"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="created">
                    created
                  </option>
                  <option value="in_production">
                    in_production
                  </option>
                  <option value="mailed">
                    mailed
                  </option>
                  <option value="delivered">
                    delivered
                  </option>
                  <option value="awaiting_review">
                    awaiting_review
                  </option>
                  <option value="completed">
                    completed
                  </option>
                </select>
                <script>
                  if (proof.status) {
                    document.getElementById("status").value = proof.status;
                  }
                </script>
              </div>
              <button
                type="submit"
                class="bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-md"
              >
                Update Status
              </button>
            </div>
          </form>
        </div>

        <div class="mt-6 bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">
            Quality Review
          </h2>
          <form method="POST" action="{{ proof.updateUrl }}">
            <input type="hidden" name="_csrf" value="{{ csrfToken }}" />

            <div class="mb-4">
              <label for="qualityRating" class="block text-sm font-medium text-gray-700 mb-1">Quality Rating (1-5)</label>
              <select
                id="qualityRating"
                name="qualityRating"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">
                  Select rating
                </option>
                <option value="1">
                  1 - Poor
                </option>
                <option value="2">
                  2 - Fair
                </option>
                <option value="3">
                  3 - Good
                </option>
                <option value="4">
                  4 - Very Good
                </option>
                <option value="5">
                  5 - Excellent
                </option>
              </select>
            </div>
            <script>
              if (proof.qualityRating) {
                document.getElementById("qualityRating").value = proof.qualityRating.toString();
              }
            </script>

            {{--  <div class="mb-4">
              <label for="printerVendor" class="block text-sm font-medium text-gray-700 mb-1">Printer Vendor</label>
              <input
                type="text"
                id="printerVendor"
                name="printerVendor"
                value="{{ proof.printerVendor || '' }}"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>  --}}

            <div class="mb-4">
              <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
              <textarea
                id="notes"
                name="notes"
                rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >{{ proof.notes || '' }}</textarea>
            </div>

            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md">
              Save Review
            </button>
          </form>
        </div>
      </div>
    </main>
  </body>
</html>
