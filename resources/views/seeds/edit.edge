<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Edit Seed - Seeds Dashboard
    </title>
    <script src="https://cdn.tailwindcss.com">

    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex">
            <div class="flex-shrink-0 flex items-center">
              <a href="{{ route('home') }}" class="text-xl font-bold text-gray-900">Seeds Dashboard</a>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
              <a
                href="{{ route('seeds.index') }}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >
                Seeds
              </a>
              <a
                href="{{ route('proofs.index') }}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >
                Proofs
              </a>
              <a
                href="{{ route('settings.edit') }}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
              >
                Settings
              </a>
            </div>
          </div>
          <div class="flex items-center">
            <form method="POST" action="{{ route('auth.logout') }}">
              <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
              <button type="submit" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">
                Logout
              </button>
            </form>
          </div>
        </div>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <div class="px-4 py-8 sm:px-0">
        <div class="max-w-2xl mx-auto bg-white shadow rounded-lg p-6">
          <h2 class="text-2xl font-bold mb-6">
            Edit Seed
          </h2>

          <form
            method="POST"
            action="{{ route('seeds.update', { publicId: seed.publicId }) }}"
            enctype="multipart/form-data"
          >
            <input type="hidden" name="_csrf" value="{{ csrfToken }}" />

            <div class="mb-4">
              <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Seed Name *</label>
              <input
                type="text"
                id="name"
                name="name"
                autocomplete="off"
                required
                value="{{ seed.name }}"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>

            <div class="mb-4">
              <label for="front" class="block text-sm font-medium text-gray-700 mb-1">Front Template ID or URL</label>
              <input
                type="text"
                id="front"
                name="front"
                placeholder="Enter template ID or URL"
                value="{{ seed.front }}"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
              <p class="mt-1 text-sm text-gray-500">
                Or upload a file below
              </p>
            </div>

            <div class="mb-4">
              <label for="frontFile" class="block text-sm font-medium text-gray-700 mb-1">Front File (PDF or JPG)</label>
              <input
                type="file"
                id="frontFile"
                name="frontFile"
                accept=".pdf,.jpg,.jpeg"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
              <p class="mt-1 text-sm text-gray-500">
                Maximum file size: 10MB. Accepted formats: PDF, JPG
              </p>
            </div>

            <div class="mb-4">
              <label for="back" class="block text-sm font-medium text-gray-700 mb-1">Back Template ID or URL</label>
              <input
                type="text"
                id="back"
                name="back"
                placeholder="Enter template ID or URL"
                value="{{ seed.back }}"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
              <p class="mt-1 text-sm text-gray-500">
                Or upload a file below
              </p>
            </div>

            <div class="mb-4">
              <label for="backFile" class="block text-sm font-medium text-gray-700 mb-1">Back File (PDF or JPG)</label>
              <input
                type="file"
                id="backFile"
                name="backFile"
                accept=".pdf,.jpg,.jpeg"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
              <p class="mt-1 text-sm text-gray-500">
                Maximum file size: 10MB. Accepted formats: PDF, JPG
              </p>
            </div>

            <div class="mb-4">
              <label for="cadence" class="block text-sm font-medium text-gray-700 mb-1">Cadence</label>
              <select
                id="cadence"
                name="cadence"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="one_time" {{ seed.cadence === 'one_time' ? 'selected' : '' }}>
                  One Time
                </option>
                <option value="weekly" {{ seed.cadence === 'weekly' ? 'selected' : '' }}>
                  Weekly
                </option>
                <option value="monthly" {{ seed.cadence === 'monthly' ? 'selected' : '' }}>
                  Monthly
                </option>
              </select>
            </div>

            <div class="mb-4">
              <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select
                id="status"
                name="status"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="active" {{ seed.status === 'active' ? 'selected' : '' }}>
                  Active
                </option>
                <option value="paused" {{ seed.status === 'paused' ? 'selected' : '' }}>
                  Paused
                </option>
              </select>
            </div>

            <div class="mb-4">
              <label for="nextRunAt" class="block text-sm font-medium text-gray-700 mb-1">Next Run</label>
              <input
                type="datetime-local"
                id="nextRunAt"
                name="nextRunAt"
                value="{{ seed.nextRunAt }}"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
              <p class="mt-1 text-xs text-gray-500">
                Leave empty to clear the next run date
              </p>
            </div>

            <div class="border-t pt-4 mt-6">
              <h3 class="text-lg font-medium mb-4">
                To Addresses
              </h3>

              <div id="addressesContainer">
                <!-- Address fields will be dynamically added here -->
              </div>

              <div class="mt-4">
                <button
                  type="button"
                  id="addAddressBtn"
                  class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md text-sm"
                >
                  + Add Address
                </button>
              </div>
            </div>

            <script>
              const addressesBase64 = "{{ addressesBase64 }}";

              const existingAddresses = JSON.parse(atob(addressesBase64));

              let addressIndex = existingAddresses.length;

              let expandedIndex = 0;

              function getAddressSummary(index) {
                const addressGroup = document.querySelector(`.address-group[data-index="${index}"]`);
                let data = {};
                if (addressGroup) {
                  addressGroup.querySelectorAll(".address-input").forEach(input => {
                    const nameMatch = input.name.match(/\[([^\]]+)\]$/);
                    if (nameMatch) {
                      data[nameMatch[1]] = input.value;
                    }
                  });
                }
                const parts = [];
                if (data.toName) parts.push(data.toName);
                if (data.addressLine1) parts.push(data.addressLine1);
                if (data.addressCity && data.addressState && data.addressZip) {
                  parts.push(`${data.addressCity}, ${data.addressState} ${data.addressZip}`);
                }
                return parts.length > 0 ? parts.join(" - ") : `Address ${index + 1}`;
              }

              function createAddressSummary(index) {
                const summaryDiv = document.createElement("div");
                summaryDiv.className = "address-summary border border-gray-200 rounded-lg p-3 mb-4 bg-gray-50 cursor-pointer hover:bg-gray-100";
                summaryDiv.dataset.index = index;
                summaryDiv.dataset.type = "summary";
                const summary = getAddressSummary(index);
                summaryDiv.innerHTML = `
                                <div class="flex justify-between items-center">
                                  <div class="flex-1">
                                    <div class="text-sm font-medium text-gray-700">Address ${index + 1}</div>
                                    <div class="text-xs text-gray-500 mt-1">${summary}</div>
                                  </div>
                                  <div class="flex items-center space-x-2">
                                    <button type="button" class="expand-address-btn text-blue-600 hover:text-blue-800 text-sm font-medium">
                                      Edit
                                    </button>
                                    ${index > 0 ? '<button type="button" class="remove-address-btn text-red-600 hover:text-red-800 text-sm font-medium">Remove</button>' : ""}
                                  </div>
                                </div>
                              `;
                summaryDiv.querySelector(".expand-address-btn").addEventListener("click", () => {
                  expandAddress(index);
                });
                const removeBtn = summaryDiv.querySelector(".remove-address-btn");
                if (removeBtn) {
                  removeBtn.addEventListener("click", e => {
                    e.stopPropagation();
                    removeAddress(index);
                  });
                }
                return summaryDiv;
              }

              function createAddressFields(index, addressData = null) {
                const addressDiv = document.createElement("div");
                addressDiv.className = "address-group border border-gray-200 rounded-lg p-4 mb-4 bg-white";
                addressDiv.dataset.index = index;
                addressDiv.dataset.type = "expanded";
                addressDiv.innerHTML = `
                                <div class="flex justify-between items-center mb-4">
                                  <h4 class="text-md font-medium text-gray-700">Address ${index + 1}</h4>
                                  <div class="flex items-center space-x-2">
                                    <button type="button" class="collapse-address-btn text-gray-600 hover:text-gray-800 text-sm font-medium">
                                      Collapse
                                    </button>
                                    ${index > 0 ? '<button type="button" class="remove-address-btn text-red-600 hover:text-red-800 text-sm font-medium">Remove</button>' : ""}
                                  </div>
                                </div>

                                <div class="mb-4">
                                  <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                  <input
                                    type="text"
                                    name="addresses[${index}][toName]"
                                    autocomplete="name"
                                    maxlength="40"
                                    value="${addressData?.toName || ""}"
                                    class="address-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                  />
                                </div>

                                <div class="mb-4">
                                  <label class="block text-sm font-medium text-gray-700 mb-1">Address Line 1 *</label>
                                  <input
                                    type="text"
                                    name="addresses[${index}][addressLine1]"
                                    autocomplete="street-address"
                                    required
                                    maxlength="64"
                                    value="${addressData?.addressLine1 || ""}"
                                    class="address-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                  />
                                </div>

                                <div class="mb-4">
                                  <label class="block text-sm font-medium text-gray-700 mb-1">Address Line 2</label>
                                  <input
                                    type="text"
                                    name="addresses[${index}][addressLine2]"
                                    autocomplete="address-line2"
                                    maxlength="64"
                                    value="${addressData?.addressLine2 || ""}"
                                    class="address-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                  />
                                </div>

                                <div class="grid grid-cols-2 gap-4 mb-4">
                                  <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
                                    <input
                                      type="text"
                                      name="addresses[${index}][addressCity]"
                                      autocomplete="address-level2"
                                      required
                                      maxlength="200"
                                      value="${addressData?.addressCity || ""}"
                                      class="address-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    />
                                  </div>
                                  <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">State (2 letters) *</label>
                                    <input
                                      type="text"
                                      name="addresses[${index}][addressState]"
                                      autocomplete="address-level1"
                                      required
                                      pattern="[A-Z]{2}"
                                      maxlength="2"
                                      value="${addressData?.addressState || ""}"
                                      class="address-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    />
                                  </div>
                                </div>

                                <div class="mb-4">
                                  <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code *</label>
                                  <input
                                    type="text"
                                    name="addresses[${index}][addressZip]"
                                    autocomplete="postal-code"
                                    required
                                    pattern="\\d{5}(-\\d{4})?"
                                    value="${addressData?.addressZip || ""}"
                                    class="address-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                  />
                                </div>
                              `;
                addressDiv.querySelector(".collapse-address-btn").addEventListener("click", () => {
                  collapseAddress(index);
                });
                const removeBtn = addressDiv.querySelector(".remove-address-btn");
                if (removeBtn) {
                  removeBtn.addEventListener("click", () => {
                    removeAddress(index);
                  });
                }
                return addressDiv;
              }

              function collapseAddress(index) {
                const expanded = document.querySelector(`.address-group[data-index="${index}"][data-type="expanded"]`);
                if (!expanded) return;
                const formFields = expanded.querySelectorAll(".address-input");
                formFields.forEach(field => {
                  field.style.display = "none";
                });
                const labels = expanded.querySelectorAll("label");
                labels.forEach(label => {
                  label.style.display = "none";
                });
                const formContent = expanded.querySelectorAll(".mb-4, .grid");
                formContent.forEach(el => {
                  if (!el.closest(".flex.justify-between")) {
                    el.style.display = "none";
                  }
                });
                const headerButtons = expanded.querySelector(".flex.items-center.space-x-2");
                if (headerButtons) {
                  headerButtons.style.display = "none";
                }
                const summary = createAddressSummary(index);
                const header = expanded.querySelector(".flex.justify-between");
                if (header && header.nextSibling) {
                  expanded.insertBefore(summary, header.nextSibling);
                } else {
                  expanded.appendChild(summary);
                }
                expanded.classList.add("collapsed");
                expanded.dataset.type = "collapsed";
                if (expandedIndex === index) {
                  expandedIndex = -1;
                }
              }

              function expandAddress(index) {
                if (expandedIndex >= 0 && expandedIndex !== index) {
                  collapseAddress(expandedIndex);
                }
                const addressGroup = document.querySelector(`.address-group[data-index="${index}"]`);
                if (!addressGroup) return;
                const summary = addressGroup.querySelector(`.address-summary[data-index="${index}"]`);
                if (summary) {
                  summary.remove();
                }
                const formFields = addressGroup.querySelectorAll(".address-input");
                formFields.forEach(field => {
                  field.style.display = "";
                });
                const labels = addressGroup.querySelectorAll("label");
                labels.forEach(label => {
                  label.style.display = "";
                });
                const formContent = addressGroup.querySelectorAll(".mb-4, .grid");
                formContent.forEach(el => {
                  el.style.display = "";
                });
                const headerButtons = addressGroup.querySelector(".flex.items-center.space-x-2");
                if (headerButtons) {
                  headerButtons.style.display = "flex";
                }
                addressGroup.classList.remove("collapsed");
                addressGroup.dataset.type = "expanded";
                expandedIndex = index;
              }

              function removeAddress(index) {
                const element = document.querySelector(`.address-group[data-index="${index}"]`);
                if (element && index > 0) {
                  element.remove();
                  updateAddressNumbers();
                  if (expandedIndex === index) {
                    expandedIndex = -1;
                  }
                }
              }

              function updateAddressNumbers() {
                const container = document.getElementById("addressesContainer");
                const addressGroups = Array.from(container.querySelectorAll(".address-group[data-index]")).sort((a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index));
                addressGroups.forEach((group, newIndex) => {
                  const oldIndex = parseInt(group.dataset.index);
                  if (oldIndex !== newIndex) {
                    group.dataset.index = newIndex;
                    group.querySelectorAll(".address-input").forEach(input => {
                      const nameMatch = input.name.match(/^addresses\[\d+\]\[(.+)\]$/);
                      if (nameMatch) {
                        input.name = `addresses[${newIndex}][${nameMatch[1]}]`;
                      }
                    });
                    const header = group.querySelector("h4");
                    if (header) {
                      header.textContent = `Address ${newIndex + 1}`;
                    }
                    const summary = group.querySelector(`.address-summary[data-index="${oldIndex}"]`);
                    if (summary) {
                      summary.dataset.index = newIndex;
                      const summaryHeader = summary.querySelector(".text-sm.font-medium");
                      if (summaryHeader) {
                        summaryHeader.textContent = `Address ${newIndex + 1}`;
                      }
                    }
                  } else {
                    const summary = group.querySelector(".address-summary");
                    if (summary) {
                      const summaryHeader = summary.querySelector(".text-sm.font-medium");
                      if (summaryHeader) {
                        summaryHeader.textContent = `Address ${newIndex + 1}`;
                      }
                    }
                  }
                });
                addressGroups.forEach((group, index) => {
                  const removeBtns = group.querySelectorAll(".remove-address-btn");
                  removeBtns.forEach(btn => {
                    btn.style.display = index === 0 ? "none" : "block";
                  });
                });
              }

              document.addEventListener("DOMContentLoaded", () => {
                const container = document.getElementById("addressesContainer");
                // Initialize with existing addresses
                existingAddresses.forEach((addr, index) => {
                  const addressFields = createAddressFields(index, addr);
                  container.appendChild(addressFields);
                  if (index > 0) {
                    collapseAddress(index);
                  }
                });
                expandedIndex = 0;
                document.getElementById("addAddressBtn").addEventListener("click", () => {
                  if (expandedIndex >= 0) {
                    collapseAddress(expandedIndex);
                  }
                  const newAddress = createAddressFields(addressIndex);
                  container.appendChild(newAddress);
                  expandedIndex = addressIndex;
                  addressIndex++;
                });
              });
            </script>

            <div class="flex justify-end space-x-4 mt-6">
              <a
                href="{{ route('seeds.show', { publicId: seed.publicId }) }}"
                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
              >
                Cancel
              </a>
              <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md">
                Update Seed
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </body>
</html>
